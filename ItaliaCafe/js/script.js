const MENU_DATA = [
  {
    categoria: "Cafetería",
    productos: [
      {
        nombre: "Café espresso",
        descripcion: "",
        precio: 2500,
        img: "/images/default.svg"
      },
      {
        nombre: "Café jarrita",
        descripcion: "",
        precio: 2500,
        img: "/images/default.svg"
      },
      {
        nombre: "Café doble",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Con leche",
        descripcion: "",
        precio: 2800,
        img: "/images/default.svg"
      },
      {
        nombre: "Cortado",
        descripcion: "",
        precio: 2800,
        img: "/images/default.svg"
      },
      {
        nombre: "Lágrima",
        descripcion: "",
        precio: 2900,
        img: "/images/default.svg"
      },
      {
        nombre: "Con crema",
        descripcion: "",
        precio: 5700,
        img: "/images/default.svg"
      },
      {
        nombre: "Irlandés",
        descripcion: "",
        precio: 6900,
        img: "/images/default.svg"
      },
      {
        nombre: "Affogato",
        descripcion: "",
        precio: 5500,
        img: "/images/default.svg"
      },
      {
        nombre: "Iced coffee",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Iced latte",
        descripcion: "",
        precio: 4500,
        img: "/images/icedlatte.png"
      },
      {
        nombre: "Café bombón",
        descripcion: "",
        precio: 6200,
        img: "/images/default.svg"
      },
      {
        nombre: "Capuccino",
        descripcion: "",
        precio: 5200,
        img: "/images/default.svg"
      },
      {
        nombre: "Freddo",
        descripcion: "",
        precio: 5800,
        img: "/images/default.svg"
      },
      {
        nombre: "Chocolatada (fría o caliente)",
        descripcion: "",
        precio: 3600,
        img: "/images/default.svg"
      },
      {
        nombre: "Submarino",
        descripcion: "",
        precio: 4700,
        img: "/images/default.svg"
      },
      {
        nombre: "Té negro",
        descripcion: "",
        precio: 3200,
        img: "/images/default.svg"
      },
      {
        nombre: "Té con leche",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Té especiales",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Mate cocido",
        descripcion: "",
        precio: 2700,
        img: "/images/default.svg"
      },
      {
        nombre: "Mate cocido con leche",
        descripcion: "",
        precio: 3200,
        img: "/images/default.svg"
      },
      {
        nombre: "Yogurt con granola, frutas y miel",
        descripcion: "",
        precio: 6300,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Desayuno Ejecutivo",
    productos: [
      {
        nombre: "Combo 1",
        descripcion: "Café o té + 2 Medialunas",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 2",
        descripcion: "Café o té + 1 Waffle con miel o salsa",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 3",
        descripcion: "Café o té + Pastafrola o coco con dulce de leche",
        precio: 7000,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 4",
        descripcion: "Café o té + 2 Tostadas con 2 dips",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 5",
        descripcion: "Café o té + 100gr de chipá",
        precio: 4800,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 6",
        descripcion: "Café o té + Medialuna de jamón y queso",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 7",
        descripcion: "Café o té + Tostada con 1 feta de jamón y queso",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 8",
        descripcion: "Café o té + Tostada con rúcula y jamón crudo",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 9",
        descripcion: "Café o té + Huevo revuelto con o sin semillas",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 10",
        descripcion: "Café o té + Yogurt con granola, frutas y miel (sin infusión)",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Combo 11",
        descripcion: "Café o té + 150gr bizcochos",
        precio: 4800,
        img: "/images/default.svg"
      },
      {
        nombre: "Cambio de infusión por jugo de naranja mediano",
        descripcion: "",
        precio: 1100,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Especialidades",
    productos: [
      {
        nombre: "Sandwich Génova (pan de molde casero, J&Q y huevo revuelto)",
        descripcion: "",
        precio: 7600,
        img: "/images/default.svg"
      },
      {
        nombre: "Opción Keto",
        descripcion: "",
        precio: 9000,
        img: "/images/default.svg"
      },
      {
        nombre: "Brusqueta Sicilia (pan de campo, Q crema con cebollita de verdeo, cerdo ahumado, rúcula y tomate)",
        descripcion: "",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Opción Keto",
        descripcion: "",
        precio: 7200,
        img: "/images/default.svg"
      },
      {
        nombre: "Brusqueta Turín (pan de campo, Q crema, palta, tomate y huevo revuelto)",
        descripcion: "",
        precio: 7600,
        img: "/images/default.svg"
      },
      {
        nombre: "Opción Keto",
        descripcion: "",
        precio: 8300,
        img: "/images/default.svg"
      },
      {
        nombre: "Brusqueta Capri (pan de campo, Q crema, frutas de estación y miel)",
        descripcion: "",
        precio: 6000,
        img: "/images/default.svg"
      },
      {
        nombre: "Opción Keto",
        descripcion: "",
        precio: 6700,
        img: "/images/default.svg"
      },
      {
        nombre: "Brusqueta Siena (pan de campo, crema de nuestro cheesecake con reducción de frutos rojos)",
        descripcion: "",
        precio: 5700,
        img: "/images/default.svg"
      },
      {
        nombre: "Opción Keto",
        descripcion: "",
        precio: 6400,
        img: "/images/default.svg"
      },
      {
        nombre: "Pancakes Roma (2 panqueques tibios con miel, salsa y frutas de estación)",
        descripcion: "",
        precio: 6700,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Bebidas",
    productos: [
      {
        nombre: "Jugo de naranja mediano",
        descripcion: "",
        precio: 3600,
        img: "/images/default.svg"
      },
      {
        nombre: "Jugo de naranja grande",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Limonada mediana",
        descripcion: "",
        precio: 3300,
        img: "/images/default.svg"
      },
      {
        nombre: "Limonada grande",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Licuado con agua",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Licuado con leche",
        descripcion: "",
        precio: 4900,
        img: "/images/default.svg"
      },
      {
        nombre: "Milkshake (sabores varios)",
        descripcion: "",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Smoothies (sabores varios)",
        descripcion: "",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua 600 ml",
        descripcion: "",
        precio: 1800,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua con gas 500 ml",
        descripcion: "",
        precio: 2000,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua saborizada 500 ml",
        descripcion: "",
        precio: 2400,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua tónica 375 ml",
        descripcion: "",
        precio: 2700,
        img: "/images/default.svg"
      },
      {
        nombre: "Gaseosa 500 ml",
        descripcion: "",
        precio: 2700,
        img: "/images/default.svg"
      },
      {
        nombre: "Energizante",
        descripcion: "",
        precio: null,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza regular 330 ml",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza regular 600 ml",
        descripcion: "",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza premium 330 ml",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza premium sin alcohol 330 ml",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Combos",
    productos: [
      {
        nombre: "Clásico",
        descripcion: "",
        precio: 7000,
        img: "/images/default.svg"
      },
      {
        nombre: "Chipá",
        descripcion: "",
        precio: 6900,
        img: "/images/default.svg"
      },
      {
        nombre: "Proteico",
        descripcion: "",
        precio: 13000,
        img: "/images/default.svg"
      },
      {
        nombre: "Fit",
        descripcion: "",
        precio: 10800,
        img: "/images/default.svg"
      },
      {
        nombre: "Italia",
        descripcion: "",
        precio: 12400,
        img: "/images/default.svg"
      },
      {
        nombre: "Mbejú",
        descripcion: "",
        precio: 11300,
        img: "/images/default.svg"
      },
      {
        nombre: "Para dos",
        descripcion: "",
        precio: 23700,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Dulces",
    productos: [
      {
        nombre: "Medialunas / Facturas",
        descripcion: "",
        precio: 1600,
        img: "/images/default.svg"
      },
      {
        nombre: "Pepas (porción)",
        descripcion: "",
        precio: 3500,
        img: "/images/default.svg"
      },
      {
        nombre: "Tostadas pan casero con 2 dips",
        descripcion: "",
        precio: 6000,
        img: "/images/default.svg"
      },
      {
        nombre: "Alfajores de la casa (2 unidades)",
        descripcion: "",
        precio: 3300,
        img: "/images/default.svg"
      },
      {
        nombre: "Porción de Cheesecake",
        descripcion: "",
        precio: 7500,
        img: "/images/cheescake.png"
      },
      {
        nombre: "Porción de tarta",
        descripcion: "",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Pastafrola",
        descripcion: "",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Bowl frutas estación, coco y miel",
        descripcion: "",
        precio: 6500,
        img: "/images/default.svg"
      },
      {
        nombre: "Waffles con miel o salsa",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Waffles con frutas o helado",
        descripcion: "",
        precio: 6700,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Bebidas",
    productos: [
      {
        nombre: "Jugo de naranja mediano",
        descripcion: "",
        precio: 3600,
        img: "/images/default.svg"
      },
      {
        nombre: "Jugo de naranja grande",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Limonada mediana",
        descripcion: "",
        precio: 3300,
        img: "/images/default.svg"
      },
      {
        nombre: "Limonada grande",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Licuado con agua",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Licuado con leche",
        descripcion: "",
        precio: 4900,
        img: "/images/default.svg"
      },
      {
        nombre: "Milkshake (sabores varios)",
        descripcion: "",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Smoothies (sabores varios)",
        descripcion: "",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua 600 ml",
        descripcion: "",
        precio: 1800,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua con gas 500 ml",
        descripcion: "",
        precio: 2000,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua saborizada 500 ml",
        descripcion: "",
        precio: 2400,
        img: "/images/default.svg"
      },
      {
        nombre: "Agua tónica 375 ml",
        descripcion: "",
        precio: 2700,
        img: "/images/default.svg"
      },
      {
        nombre: "Gaseosa 500 ml",
        descripcion: "",
        precio: 2700,
        img: "/images/default.svg"
      },
      {
        nombre: "Energizante",
        descripcion: "",
        precio: null,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza regular 330 ml",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza regular 600 ml",
        descripcion: "",
        precio: 5400,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza premium 330 ml",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
      {
        nombre: "Cerveza premium sin alcohol 330 ml",
        descripcion: "",
        precio: 4300,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Salados",
    productos: [
      {
        nombre: "Chipá",
        descripcion: "",
        precio: 3000,
        img: "/images/default.svg"
      },
      {
        nombre: "Bizcochitos",
        descripcion: "",
        precio: 3800,
        img: "/images/default.svg"
      },
      {
        nombre: "Sandwich J&Q pan casero",
        descripcion: "",
        precio: 6800,
        img: "/images/default.svg"
      },
      {
        nombre: "Tostón con huevo revuelto J&Q",
        descripcion: "",
        precio: 7000,
        img: "/images/default.svg"
      },
      {
        nombre: "Medialunas con J&Q",
        descripcion: "",
        precio: 4800,
        img: "/images/default.svg"
      },
      {
        nombre: "Sandwich jamón crudo y rúcula",
        descripcion: "",
        precio: 10000,
        img: "/images/default.svg"
      },
      {
        nombre: "Tostón con revuelto de J&Q",
        descripcion: "",
        precio: 6600,
        img: "/images/default.svg"
      },
      {
        nombre: "Mbejú relleno",
        descripcion: "",
        precio: 8600,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Adicionales",
    productos: [
      {
        nombre: "Huevo",
        descripcion: "",
        precio: 860,
        img: "/images/default.svg"
      },
      {
        nombre: "Queso",
        descripcion: "",
        precio: 1100,
        img: "/images/default.svg"
      },
      {
        nombre: "Jamón",
        descripcion: "",
        precio: 1100,
        img: "/images/default.svg"
      },
      {
        nombre: "Jamón crudo",
        descripcion: "",
        precio: 1700,
        img: "/images/default.svg"
      },
      {
        nombre: "Dip",
        descripcion: "",
        precio: 1400,
        img: "/images/default.svg"
      },
      {
        nombre: "Crema chantilly",
        descripcion: "",
        precio: 1200,
        img: "/images/default.svg"
      },
      {
        nombre: "Jugo de naranja en combo",
        descripcion: "",
        precio: 2200,
        img: "/images/default.svg"
      },
      {
        nombre: "Vaso de soda mediano",
        descripcion: "",
        precio: 1100,
        img: "/images/default.svg"
      },
      {
        nombre: "Helado / Frutas",
        descripcion: "",
        precio: 1600,
        img: "/images/default.svg"
      },
      {
        nombre: "Miel / Salsa",
        descripcion: "",
        precio: 650,
        img: "/images/default.svg"
      },
      {
        nombre: "Pan Keto (unidad)",
        descripcion: "",
        precio: 1700,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "Mbejú",
    productos: [
      {
        nombre: "Jamón y queso",
        descripcion: "",
        precio: 9000,
        img: "/images/default.svg"
      },
      {
        nombre: "Rúcula y jamón crudo",
        descripcion: "",
        precio: 10500,
        img: "/images/default.svg"
      },
      {
        nombre: "Rúcula, palta, huevo revuelto y tomates confitados",
        descripcion: "",
        precio: 10500,
        img: "/images/default.svg"
      },
      {
        nombre: "Rúcula, cerdo ahumado y tomates confitados",
        descripcion: "",
        precio: 10500,
        img: "/images/default.svg"
      },
      {
        nombre: "Palta y huevo revuelto",
        descripcion: "",
        precio: 9000,
        img: "/images/default.svg"
      },
      {
        nombre: "Jamón, rúcula y tomates confitados",
        descripcion: "",
        precio: 9000,
        img: "/images/default.svg"
      },
      {
        nombre: "Mbejú Italia (masa + 3 ingredientes a elección)",
        descripcion: "",
        precio: 10500,
        img: "/images/default.svg"
      },
    ],
  },
  {
    categoria: "After Office",
    productos: [
      {
        nombre: "Fernet con coca",
        descripcion: "",
        precio: 5000,
        img: "/images/default.svg"
      },
      {
        nombre: "Campari con jugo de naranja",
        descripcion: "",
        precio: 4500,
        img: "/images/default.svg"
      },
      {
        nombre: "Jarra de limonada (2lts)",
        descripcion: "",
        precio: 11500,
        img: "/images/default.svg"
      },
      {
        nombre: "Crep jamón crudo rúcula queso crema",
        descripcion: "",
        precio: 4600,
        img: "/images/default.svg"
      },
      {
        nombre: "Crep cerdo ahumado rúcula tomate queso crema",
        descripcion: "",
        precio: 4600,
        img: "/images/default.svg"
      },
      {
        nombre: "Crep jamón queso lechuga tomate queso crema",
        descripcion: "",
        precio: 4600,
        img: "/images/default.svg"
      },
      {
        nombre: "Pizzeta jamón y morrones",
        descripcion: "",
        precio: 9000,
        img: "/images/default.svg"
      },
      {
        nombre: "Pizzeta Provolone",
        descripcion: "",
        precio: 9000,
        img: "/images/default.svg"
      },
      {
        nombre: "Pizzeta rúcula y jamón crudo",
        descripcion: "",
        precio: 10000,
        img: "/images/default.svg"
      },
      {
        nombre: "Pizzeta muzzarela",
        descripcion: "",
        precio: 8000,
        img: "/images/default.svg"
      },
      {
        nombre: "Brownie con helado",
        descripcion: "",
        precio: 4500,
        img: "/images/default.svg"
      },
      {
        nombre: "Vaso helado (3 bochas con salsa y garrapiñada)",
        descripcion: "",
        precio: 3500,
        img: "/images/default.svg"
      },
    ],
  },
];

// Función para formatear precio a moneda local (ARS)
function formatPrice(num) {
  if (num === null || num === undefined) return "";
  return new Intl.NumberFormat("es-AR", {
    style: "currency",
    currency: "ARS",
    minimumFractionDigits: 0,
  }).format(num);
}

// Función para crear un elemento DOM con clases y atributos
function createElement(type, options = {}) {
  const el = document.createElement(type);
  if (options.className) el.className = options.className;
  if (options.text) el.textContent = options.text;
  if (options.html) el.innerHTML = options.html;
  if (options.attrs) {
    Object.entries(options.attrs).forEach(([k, v]) => el.setAttribute(k, v));
  }
  return el;
}

// Renderiza TODOS los productos, agrupados por categoría
function renderAllProducts() {
  const container = document.getElementById("menu-container");
  container.innerHTML = "";

  MENU_DATA.forEach((catData) => {
    // Omitir la categoría de advertencia TACC si no tiene productos
    if (catData.categoria.includes("Nuestra Cocina") && catData.productos.length === 0) {
      const note = createElement("section", { className: "menu-section" });
      const title = createElement("h2", {
        html: `<u><strong>${catData.categoria}</strong></u>`,
      });
      note.appendChild(title);
      container.appendChild(note);
      return; // Continuar con la siguiente categoría
    }

    if (catData.productos.length === 0) return;

    const section = createProductSection(catData);
    container.appendChild(section);
  });
}

// Función auxiliar para crear una sección de productos
function createProductSection(catData) {
  const sectionId = catData.categoria.replace(/\s+/g, "-").toLowerCase();
  const section = createElement("section", {
    className: "menu-section",
    attrs: { id: sectionId, "data-category": catData.categoria },
  });
  const h2 = createElement("h2", { text: catData.categoria });
  section.appendChild(h2);

  catData.productos.forEach(({ nombre, descripcion, precio, img }) => {
    const item = createProductItem({ nombre, descripcion, precio, img });
    section.appendChild(item);
  });

  return section;
}

// Función auxiliar para crear un item de producto
function createProductItem({ nombre, descripcion, precio, img }) {
  const item = createElement("article", { className: "menu-item" });

  // Info
  const info = createElement("div", { className: "product-info" });
  const nameEl = createElement("h3", { className: "product-name", text: nombre });
  info.appendChild(nameEl);
  if (descripcion && descripcion.trim() !== "") {
    const descEl = createElement("p", { className: "product-desc", text: descripcion });
    info.appendChild(descEl);
  }
  if (precio !== null && precio !== undefined) {
    const priceEl = createElement("div", { className: "product-price", text: formatPrice(precio) });
    info.appendChild(priceEl);
  }
  item.appendChild(info);

  // Imagen
  const imgContainer = createElement("div", {
    className: "product-img-container",
    attrs: { tabindex: "0", role: "button", "aria-label": `Ver imagen del producto ${nombre}` },
  });

  // Si imagen es /images/default.svg, no se agranda (nozoom)
  if (img === "/images/default.svg") {
    imgContainer.classList.add("nozoom");
  }

  // Imagen dentro
  const imgEl = createElement("img", {
    className: "product-img",
    attrs: {
      src: img,
      alt:
        img === "/images/default.svg"
          ? "Imagen genérica de producto sin foto con bordes redondeados"
          : `Foto del producto ${nombre} con bordes redondeados`,
      loading: "lazy",
      draggable: "false",
    },
  });
  imgContainer.appendChild(imgEl);
  item.appendChild(imgContainer);

  // Zoom imagen al click excepto /images/default.svg
  if (img !== "/images/default.svg") {
    imgContainer.addEventListener("click", () => openLightbox(img, nombre));
    imgContainer.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        openLightbox(img, nombre);
      }
    });
  }

  return item;
}

// --- Función para normalizar texto (quitar acentos y a minúsculas) ---
function normalizeText(text) {
  if (!text) return "";
  return text
    .toLowerCase()
    .normalize("NFD") // Separa los caracteres base de los diacríticos (acentos)
    .replace(/[\u0300-\u036f]/g, ""); // Elimina los diacríticos
}

// --- Lógica de Búsqueda ---
function filterProducts() {
  const searchTerm = normalizeText(document.getElementById("search-input").value);
  const sections = document.querySelectorAll(".menu-section");

  sections.forEach((section) => {
    const items = section.querySelectorAll(".menu-item");
    let sectionHasVisibleItems = false;

    items.forEach((item) => {
      const name = normalizeText(item.querySelector(".product-name").textContent);
      const desc = normalizeText(item.querySelector(".product-desc")?.textContent);
      const isVisible = name.includes(searchTerm) || desc.includes(searchTerm);
      item.style.display = isVisible ? "" : "none";
      if (isVisible) sectionHasVisibleItems = true;
    });

    // Ocultar título de la sección si no tiene items visibles
    section.style.display = sectionHasVisibleItems ? "" : "none";
  });
}

// --- Lógica de Scroll ---
let lastScrollY = window.scrollY;

function handleScroll() {
  const stickyControls = document.getElementById("sticky-controls");
  const categoryBar = stickyControls.querySelector(".category-bar");
  const currentScrollY = window.scrollY;

  // Ocultar barra de categorías en móvil al hacer scroll hacia abajo
  if (window.innerWidth <= 768) {
    if (currentScrollY > lastScrollY && currentScrollY > stickyControls.offsetTop + 50) {
      categoryBar.classList.add("hidden-on-scroll"); // Ocultar
    } else {
      categoryBar.classList.remove("hidden-on-scroll"); // Mostrar
    }
  }
  lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY; // Evita valores negativos en iOS
}

// --- Lógica de Scrollspy (Intersection Observer) ---
function createScrollspy() {
  const sections = document.querySelectorAll(".menu-section");
  const observer = new IntersectionObserver(
    (entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const categoryName = entry.target.dataset.category;
          updateActiveCategory(categoryName);
        }
      });
    },
    { rootMargin: "-40% 0px -60% 0px" } // Activa cuando la sección está en el medio
  );

  sections.forEach((section) => {
    if (section.dataset.category) {
      observer.observe(section);
    }
  });
}

function updateActiveCategory(categoryName) {
  categoryButtons.forEach((btn) => {
    if (btn.textContent.trim() === categoryName) {
      btn.classList.add("category-active");
      btn.setAttribute("aria-pressed", "true");
      // Scroll suave de la barra de categorías para mostrar el botón activo
      btn.scrollIntoView({ behavior: "smooth", inline: "center", block: "nearest" });
    } else {
      btn.classList.remove("category-active");
      btn.setAttribute("aria-pressed", "false");
    }
  });
}

// Insertar menú según categoría (REUTILIZADO PARA COMPATIBILIDAD, AHORA OBSOLETO)
function renderMenu(seleccionada) {
  // Nota especial para primera categoría si está seleccionada y sin productos
  if (seleccionada === "Nuestra Cocina No Es 100% Sin Tacc, A Excepción De Nuestras Opciones De Pastelería (consultar Stock)") {
    const note = createElement("section", { className: "menu-section" });
    const title = createElement("h2", {
      html: "<u><strong>Nuestra cocina no es 100% sin TACC, a excepción de nuestras opciones de pastelería (consultar stock)</strong></u>",
    });
    note.appendChild(title);
    container.appendChild(note);
    return; // No mostrar productos en esta categoría
  }

  // Scroll a la sección
  const sectionId = seleccionada.replace(/\s+/g, "-").toLowerCase();
  const sectionEl = document.getElementById(sectionId);
  if (sectionEl) {
    sectionEl.scrollIntoView({ behavior: "smooth" });
  }
}

// Lightbox funcionalidad
const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightbox-img");
const lightboxClose = document.getElementById("lightbox-close");

function openLightbox(src, nombre) {
  lightboxImg.src = src;
  lightboxImg.alt = `Imagen ampliada del producto ${nombre} con bordes redondeados`;
  lightbox.classList.add("is-visible");
  document.body.style.overflow = "hidden";
  lightboxClose.focus();
}

function closeLightbox() {
  lightbox.classList.remove("is-visible");
  lightboxImg.src = "";
  document.body.style.overflow = "";
  // Volver foco al menú
  document.activeElement.blur();
}

// Eventos cerrar lightbox
lightboxClose.addEventListener("click", closeLightbox);
lightbox.addEventListener("click", (e) => {
  if (e.target === lightbox) closeLightbox();
});
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && lightbox.classList.contains("is-visible")) {
    closeLightbox();
  }
});

// Manejo categorías
const categoryButtons = document.querySelectorAll(".category-bar .category");
categoryButtons.forEach((btn) => {
  btn.addEventListener("click", (e) => {
    const categoryName = e.target.textContent.trim();
    const sectionId = categoryName.replace(/\s+/g, "-").toLowerCase();
    const sectionElement = document.getElementById(sectionId);
    if (sectionElement) {
      // Desactivamos temporalmente el observer para evitar conflictos
      window.removeEventListener("scroll", handleScroll, { passive: true });
      lenis.scrollTo(sectionElement, { offset: -150 }); // Usamos Lenis para el scroll
      updateActiveCategory(categoryName);
      // Reactivamos el listener
      setTimeout(() => window.addEventListener("scroll", handleScroll, { passive: true }), 1000);
    }
  });
});

// --- INICIALIZACIÓN ---
let lenis; // Declaramos la variable Lenis

document.addEventListener("DOMContentLoaded", () => {
  renderAllProducts();
  document.getElementById("search-input").addEventListener("input", filterProducts);
  window.addEventListener("scroll", handleScroll, { passive: true });
  createScrollspy();
  updateActiveCategory(categoryButtons[0].textContent.trim()); // Activa la primera categoría al cargar

  // --- Inicialización de Lenis (Smooth Scroll) ---
  lenis = new Lenis({
    duration: 1.2,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
  });

  function raf(time) {
    lenis.raf(time);
    requestAnimationFrame(raf);
  }

  requestAnimationFrame(raf);

  // --- Lógica para el desplegable "Ver más" en móvil ---
  const moreInfoToggle = document.getElementById("more-info-toggle");
  const moreInfoPanel = document.getElementById("more-info-panel");
  const mobileOverlay = document.getElementById("mobile-info-overlay");
  const closeMoreInfoBtn = document.getElementById("close-more-info");

  function openMobileInfo() {
    moreInfoToggle.setAttribute("aria-expanded", "true");
    moreInfoPanel.classList.add("is-open");
    mobileOverlay.classList.add("is-active");
    document.body.style.overflow = "hidden"; // Bloquea el scroll del fondo
  }

  function closeMobileInfo() {
    moreInfoToggle.setAttribute("aria-expanded", "false");
    moreInfoPanel.classList.remove("is-open");
    mobileOverlay.classList.remove("is-active");
    document.body.style.overflow = ""; // Restaura el scroll
  }

  if (moreInfoToggle && moreInfoPanel && mobileOverlay && closeMoreInfoBtn) {
    moreInfoToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const isExpanded = moreInfoPanel.classList.contains("is-open");
      if (isExpanded) {
        closeMobileInfo();
      } else {
        openMobileInfo();
      }
    });

    // Cierra el panel si se hace clic en el overlay
    mobileOverlay.addEventListener("click", closeMobileInfo);

    // Cierra el panel si se hace clic en la X
    closeMoreInfoBtn.addEventListener("click", closeMobileInfo);
  }

  // --- Lógica para el panel de horarios en MÓVIL ---
  const mobileHoursToggle = document.getElementById("mobile-hours-toggle");
  const mobileHoursPanel = document.getElementById("mobile-hours-panel");
  const closeMobileHoursBtn = document.getElementById("close-mobile-hours");

  function openMobileHours() {
    mobileHoursPanel.classList.add("is-open");
    mobileHoursToggle.setAttribute("aria-expanded", "true");
  }

  function closeMobileHours() {
    mobileHoursPanel.classList.remove("is-open");
    mobileHoursToggle.setAttribute("aria-expanded", "false");
  }

  if (mobileHoursToggle && mobileHoursPanel && closeMobileHoursBtn) {
    mobileHoursToggle.addEventListener("click", (e) => {
      e.stopPropagation(); // Detiene la propagación para que no cierre el panel de "Ver Info"
      openMobileHours();
    });

    closeMobileHoursBtn.addEventListener("click", closeMobileHours);
    // También se puede cerrar haciendo clic en el overlay principal
    mobileOverlay.addEventListener("click", closeMobileHours);
  }

  // --- Lógica para el desplegable de horarios en ESCRITORIO ---
  const desktopHoursToggle = document.getElementById("desktop-hours-toggle");
  const desktopHoursPanel = document.getElementById("desktop-hours-panel");
  const closeDesktopHoursBtn = document.getElementById("close-desktop-hours");

  if (desktopHoursToggle && desktopHoursPanel && closeDesktopHoursBtn) {
    desktopHoursToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = desktopHoursPanel.classList.toggle("is-open");
      desktopHoursToggle.setAttribute("aria-expanded", isOpen);
    });

    // Cierra el panel al hacer clic en la X
    closeDesktopHoursBtn.addEventListener("click", () => {
      desktopHoursPanel.classList.remove("is-open");
      desktopHoursToggle.setAttribute("aria-expanded", "false");
    });

    // Cierra el panel si se hace clic fuera
    document.addEventListener("click", (e) => {
      if (desktopHoursPanel.classList.contains("is-open") && !desktopHoursPanel.contains(e.target) && !desktopHoursToggle.contains(e.target)) {
        desktopHoursPanel.classList.remove("is-open");
        desktopHoursToggle.setAttribute("aria-expanded", "false");
      }
    });
  }

  // --- Lógica para el indicador de Abierto/Cerrado ---
  function checkOpenStatus() {
    const schedule = {
      0: null, // Domingo (Cerrado)
      1: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }], // Lunes
      2: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }], // Martes
      3: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }], // Miércoles
      4: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }], // Jueves
      5: [{ open: "07:00", close: "12:30" }, { open: "17:00", close: "21:00" }], // Viernes
      6: [{ open: "09:15", close: "12:30" }, { open: "17:00", close: "21:00" }], // Sábado
    };

    const now = new Date();
    const dayOfWeek = now.getDay(); // 0 = Domingo, 1 = Lunes, ...
    const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');

    const todaysSchedule = schedule[dayOfWeek];
    let isOpen = false;

    if (todaysSchedule) {
      for (const slot of todaysSchedule) {
        if (currentTime >= slot.open && currentTime < slot.close) {
          isOpen = true;
          break;
        }
      }
    }

    const statusIndicator = document.getElementById("open-status-indicator");
    const mobileStatusIndicator = document.getElementById("mobile-open-status-indicator");

    const setStatus = (indicator, isOpen) => {
      if (!indicator) return;
      if (isOpen) {
        indicator.textContent = "Abierto";
        indicator.className = "open-status is-open";
      } else {
        indicator.textContent = "Cerrado";
        indicator.className = "open-status is-closed";
      }
    };

    setStatus(statusIndicator, isOpen);
    setStatus(mobileStatusIndicator, isOpen);
  }

  // Comprobar el estado al cargar la página y luego cada minuto
  checkOpenStatus();
  setInterval(checkOpenStatus, 60000); // 60000 ms = 1 minuto
});
